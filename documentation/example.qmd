---
title: "Hierarchical models and sequential model fits"
author: "Leontine"
format: html
editor: visual
---

# Overview

In this document we explain

1.  how we set up a hierarchical model for a parameter; this code set up was introduced in <https://github.com/AlkemaLab/BayesTransitionModels>.

2.  how we fix higher level parameters for that set up when doing sequential runs.

# Set up

Load relevant packages, including our own

```{r}
#| include: false
library(here)
library(tidyverse)
library(ggplot2)
library(haven)
library(stringr)
library(cmdstanr)
library(truncnorm) # for inits
library(bayesplot) # diagnostic plots
library(posterior) # else error for as_draws_list
devtools::load_all(here::here())
```

Read in data and preprocess as usual

```{r}
#| include: false
data_folder <- "data_raw"
dat <- read_csv(here::here(data_folder, "coverage_data.csv"))
dat_subnat <- read_csv(here::here(data_folder, "coverage_data_subnat.csv"))

```

Let's use columns `cluster` and `subcluster` and `iso`:

```{r}
hierarchical_level <- c("intercept",  "subcluster", "iso")
dat %>% select(iso, cluster, subcluster)
```

Summary of clusters and subclusters, after selecting one row per country

```{r}
dat %>%
  group_by(iso) %>%
  filter(year == max(year)) %>%
  select(country, iso, subcluster, cluster) %>%
  group_by(cluster) %>%
  summarize(nsubclusters = length(unique(subcluster)), ncountries = n())
```

# Model fitting

## Model set up

Let's consider the following model (we won't bother with logit-transforms):

-   parameter to estimate = $\mu_c$ = country-specific coverage (during entire period)

-   data model: $y_i \sim N(\mu_{c[i]}, \sigma_y^2)$

-   hierarchical model for $\mu_c$:

    -   $\mu_c \sim N(\mu_{s[c]}^{(subregion)}, \sigma_{\mu, across-country}^2)$ ,

    -   $\mu_s^{(subregion)} \sim N(\mu_{r[s]}^{(region)}, \sigma_{\mu, across-subregions}^2)$,

    -   $\mu_r^{(region)} \sim N(\mu^{(global)}, \sigma_{\mu, across-regions}^2)$

Note that an equivalent specification of the hierarchical model (the one we'll use in the stan model) is as follows:

-   $\mu_c =  \mu^{(global)} + \eta_{r[s[c]]]}^{(region)} + \eta_{s[c]}^{(subregion)} + \eta_c$ with

-   $\eta_c \sim N(0, \sigma_{\mu, across-country}^2)$ ,

-   $\eta_s^{(subregion)} \sim N(0, \sigma_{\mu, across-subregions}^2)$,

-   $\eta_r^{(region)} \sim N(0, \sigma_{\mu, across-regions}^2)$

In addition, in the stan model, we will use that we can write $\eta = \sigma\cdot \gamma$ where $\gamma \sim N(0,1)$. In addition, with the same set up, if $\mu^{(global)}$ has prior

$$\mu^{(global)} \sim N(0, s_{\mu, global}^2),$$then we can write $\mu^{(global)} = s_{\mu, global}\cdot \gamma^{(global)}$, with $s$ being the fixed prior standard deviation (as opposed to a SD that's estimated). All that combined, we get

-   $\mu_c =  s_{global}\cdot \gamma_{global} + \sigma_{\mu, region}\cdot \gamma_{r[s[c]]]}^{(region)} + \sigma_{\mu, subregion}\cdot\gamma_{s[c]}^{(subregion)} + \sigma_{\mu, country}\cdot\gamma_{\mu, c}$ with

-   $\gamma \sim N(0,1)$ for each gamma (one global, $R$ region, $S$ subregions, $C$ countries).

The set up and notation in stan/R, in terms of parameters, using parameter mu as an example, is currently as follows:

-   mu_raw refers to the vector with ALL $\gamma$s, including the global one.The ordering is global-allregional-allsubregional-country.

-   mu_sigma referred to the vector of stacked sigmas, excluding $s_{\mu, global}$ (in the original package, it was called mu_sigma_raw).

-   mu_star refers to the vector with (mu global and ALL $\eta$s). we get mu_stars from mu_raw and the vector ($s_{\mu, global}$ , mu_sigma), using the stan `scale_blocks` function.

-   mu refers to the final $\mu$s at the country level. Matrix multiplication is used to obtain the mu country vector from the mu_stars. The full matrix `mu_model_matrix` is a sparse matrix, with 1s and 0s (columns refer to $\mu_{global}$, the regional etas, the subregional etas, the country etas). The matrix multiplication is implemented using the stan function csr_matrix_times_vector, using a decomposition of `mu_model_matrix` into different parts U, V, W.

-   Because of the sequential fitting, for mu_raw and mu_sigma, we also had to distinguish between parameters that were fixed vs those that were estimated. We do so with the \_fixed and \_estimate additions, i.e. the vector of mu_raws is produced from mu_raw_fixed and mu_raw_estimate.

## Model fitting

global model fit

```{r}
fit_global <- fit_model_localhierarchy(runstep = "global_national",
                              hierarchical_level     =  hierarchical_level,
                              survey_df = dat,
                              chains = 4)

```

create summary object

```{r}
fit_global$post_summ <- get_posterior_summaries(fit_global)
fit_global$post_summ

```

do local fit... here we fix things but do get results for all countries

```{r}
fit_local <- fit_model_localhierarchy(runstep = "local_national",
                                  global_fit = fit_global,
                                  survey_df = dat,
                                  chains = 4)
```

#### Produce and check outputs

get summaries, takes a little while. this creates, per fit, a list with each entry being one level, and the results (mu estimates) for that level

```{r}
res_global <- posterior_summary_hierparam(fit = fit_global, parname = "mu")
res_local <- posterior_summary_hierparam(fit = fit_local, parname = "mu")

```

Plots that show outputs

```{r}
plot_posterior_summaries(res = res_global, modelname1 = "global")
```

how values have been fixed in the local runs

```{r}
plot_posterior_summaries(res = res_local, 
                         res2 = res_global,
                         modelname2 = "global", modelname1 = "local") 

```

selecting specific levels

```{r}
plot_posterior_summaries(res = res_local, 
                         res2 = res_global,
                         modelname2 = "global", modelname1 = "local",
                        hierarchy_select = "subcluster")



```

Level and selected areas

```{r}
plot_posterior_summaries(res = res_local, 
                         res2 = res_global,
                         modelname2 = "global", modelname1 = "local",
                        hierarchy_select = "iso",
                        areas_select = res_local$iso$name[1:100])

```

# Summary object

Going through what's happening to create the summary object

Set up hierarchical structures, folow the hierdata.qmd

```{r}
area <- "iso"
```

Create district index for matching district and district index

```{r}
geo_unit_index <- get_geo_unit_index_data(dat,
                                          hierarchical_levels = c(hierarchical_level), 
                                          area = area)
geo_unit_index
```

```{r}
hier_data <- hierarchical_data(geo_unit_index, hierarchical_level)
names(hier_data)
# hier_data # not printing, model matrix is too large, see toy example instead


```

This is where global fit is used to fix values

```{r}
hier_stan_data <- hierarchical_param_stan_data(
  global_fit = fit_global,
  param_name = "mu",
  param_data = hier_data,
  hierarchical_terms_fixed = hierarchical_level[1:2], 
  hierarchical_sigmas_fixed = hierarchical_level[1:3]
)
names(hier_stan_data)
```

# Prior-posts 

sigmas

```{r}
plot_prior_post_sigmas(fit = fit_global, parname = "mu")

```

create plots for mu_raws

```{r}
plots <- plot_mu_raw(fit = fit_global, parname = "mu")
# a list with plots
```

summary plots gives summaries, 30 at a time

```{r}
plots[["summary_plots"]][[1]]

```

specific prior-post plots for one parameter are in plots\[\["plots_allmuraw"\]\]

```{r}
plots[["plots_allmuraw"]][[1]]
```

Simple trace plots etc

```{r}

fit <- fit_global
 parname_list <- list( c("mu_raw_estimate[1]",
                          "mu_sigma_estimate"))
#    plot_dirandname <- file.path(fit$output_dir, paste0(runname, "diagnostics.pdf"))
#    pdf(plot_dirandname, width = 11, height = 11)
    for (i in 1:length(parname_list)){
      parname <- parname_list[[i]]
      samp <- fit$samples$draws(parname )
      #mcmc_trace(samp)
      p <- mcmc_dens_overlay(samp)
      # for more than 1 parameter
      #mcmc_pairs(samp)
      print(p)
    }
#    dev.off()
```
# Subnational estimation 

## Equations 
We extend the model with an additional level of hierarchy, here subnational regions. The simplest set up is as follows: 

-   Parameter to estimate = $\mu_r^{(subnat)}$ = subnational-region-specific coverage 

-   We assume that $\mu_r^{(subnat)} =  \mu_{c[r]} + \eta_{r}^{(subnat)}$,  with $\eta_r^{(subnat)} \sim N(0, \sigma_{\mu, across-subnat}^2)$, where $\sigma_{\mu, across-subnat}^2$ refers to across-subnational-region variance. The subnational $\eta$ can be parametrized as before, i.e. $\eta = \sigma\cdot \gamma$ where $\gamma \sim N(0,1)$. 

- We can consider a data model for data observed at the subnational level as follows: $y_i^{(region)} \sim N(\mu_{r[i]}^{(subnat)}, \sigma_y^{2(subnat)})$. Here $\sigma_y^{2(subnat)}$ is the subnational error variance which is likely to be larger than the national-level variance due to larger sampling errors at the subnational level. (Note that in real examples, sampling error is calculated for an observation and included in the variance term, to capture differences between national and subnational level observations). 

- Data on national level can be used as well, by aggregation subnational estimates. This is left out of this package but can be found in fpet2025 and BayesCoverage. 

## Model fitting
In model fitting, we can fit a global subnational model using subnational data from different countries and without fixing any parameters. Alternatively, we can fix parameters based on fits to national level data. This second approach is helpful when subnational level data are more limited as compared to national level data. 

We illustrate the sequential approach where subnational estimates are obtained using information from a global national fit. The model that is fitted is as follows:  

- We set $\mu_r^{(subnat)} =  \mu_{c[r]} + \eta_{r}^{(subnat)}$, and set $\mu_{c[r]} = \hat{\mu}_{c[r]}, the posterior mean from a fit to national level data. (The model could also be fitted using fixed values up to one level above the country level, to introduce a hierarchical model for the subnational parameters). 

- In this simplified example, we set $\sigma_y^{2(subnat)} = \sigma_y^2$. 

We fit a global subnational model with these settings 
```{r}
fit_globalsubnat <- fit_model_localhierarchy(runstep = "global_subnational",
                             area = "subnat",
                      
                              survey_df = dat_subnat,
                              global_fit = fit_global,
                              chains = 4)


```

Here only one new sigma is estimated:
```{r}
plot_prior_post_sigmas(fit = fit_globalsubnat, parname = "mu")

```

We can obtain the posterior summaries 
```{r}
fit_globalsubnat$post_summ <- get_posterior_summaries(fit_globalsubnat)

```

Note that values of sigmas for higher levels are the same in the global national and subnational fit. However, mu_raws may be different if different countries were included or ordered differently. (this is documented in and reproducable with fit_global$geo_unit_index )
```{r}
fit_globalsubnat$post_summ %>%
  filter(variable_no_index == "mu_sigma")
fit_global$post_summ %>%
  filter(variable_no_index == "mu_sigma")
```

fitting a local subnational model 
(note that if the data are from a new country, and national mu's were fixed, this approach does not work. See xxx for a fix)
```{r}
fit_local <- fit_model_localhierarchy(runstep = "local_subnational",
                                  area = "subnat",
                                  global_fit = fit_globalsubnat,
                                  survey_df = dat_subnat,
                                  chains = 4)
```

checking summaries 
```{r}
res_globalsubnat <- posterior_summary_hierparam(fit = fit_globalsubnat, parname = "mu")
res_localsubnat <- posterior_summary_hierparam(fit = fit_local, parname = "mu")

```

comparison plots, local subnational and various other fits  
```{r}
plot_posterior_summaries(res = res_localsubnat, res2 = res_global,
                              modelname2 = "global national", modelname1 = "local",
                         hierarchy_select = "subcluster")
```

The fixed country estimates that were used: 
```{r}
plot_posterior_summaries(res = res_localsubnat, 
                         res2 = res_global,
                         modelname2 = "global national", modelname1 = "local",
                         hierarchy_select = "iso")
```



