---
# for rendering to pdf
title: ""
author: ""
# for rendering to html
# title: "localhierarchy: an R package to facilitate fitting of global and local Bayesian hierarchical models"
# author:
#   - name: "Leontine Alkema"
#     affiliations:
#       - name: "Department of Biostatistics and Epidemiology, University of Massachusetts Amherst, USA"
#         id: "1"
#     email: "lalkema@umass.edu"
#   - name: "Shauna Mooney"
#     affiliations:
#       - name: "Hamilton Institute and Department of Mathematics and Statistics, Maynooth University, Ireland"
#         id: "2"
#   - name: "Evan Ray"
#     affiliations:
#       - id: "1"
#   - name: "Herbert P. Susmann"
#     affiliations:
#       - name: "Division of Biostatistics, Department of Population Health, NYU Grossman School of Medicine, USA"
# 
#         id: "3"

date: today
format:
  # html:
  #   number-sections: true
  pdf:
    number-sections: true
    latex-engine: pdflatex
    include-before-body: title.tex
    include-in-header:
      - file: preamble.tex
#  docx: default  # Enable if you want Word output format as well
editor: visual
# execute:
#   cache: true

abstract: |
  Bayesian hierarchical models are widely used in global health estimation, where data availability may vary across national or subnational populations. Such models are typically fitted to a global database, e.g., to produce national-level estimates for all countries in the world or in some region. To facilitate analysis at a local level, models are often desirable that are informed by global models but can be fitted to just a subset of the data, such as data for one country. We refer to such models as local models: models that are derived from global hierarchical models but adapted such that they can be fitted to the data from one population alone.

  We present the `localHierarchy` R package, which provides functionality for fitting Bayesian hierarchical models in settings where both global and local estimation is required. The package provides R functions and Stan model components to support global modeling, in which all parameters in hierarchical models are estimated, and local modeling, in which parameters are estimated for only one or a small number of populations, using fixed values from a global model fit.

  This article presents a practical introduction to the package for the applied user and illustrates the package’s functionality through examples for national and subnational estimation.
keywords: Bayesian hierarchical model; R; Stan; Local models for one population
bibliography: bibliography.bib
---

```{r}
#| include: false
library(localhierarchy)
```

# Introduction

<!-- % context: global health estimation exercises, use of bayesian hier models, examples -->

In global health estimation, Bayesian hierarchical models have become a cornerstone methodology, enabling the integration of diverse data sources to produce reliable estimates across multiple populations and regions. For example, they are used to estimate and forecast family planning indicators for the FP2030 initiative [@alkema_2024evol], incidence of low birth weight [@okwaraji_national_2024], abortion and unintended pregnancies rates [@bearak_unintended_2020], and maternal mortality by the United Nations Interagency Group [@peterson_bayesian_2024]. In these efforts, national or subnational estimates are often required for population-periods with limited data availability. Bayesian hierarchical models—whether used directly or for specific components within larger modeling frameworks—are valuable in these contexts because they facilitate the sharing of information across populations. As a result, global modeling exercises typically fit Bayesian hierarchical models to comprehensive global databases, producing national-level estimates for all countries worldwide.

<!-- % introduce local models and how they comapre to global model, why they are needed -->

To facilitate local-level analysis, it is often desirable to use models that are informed by global models but can be fitted to just a subset of the data, such as data from a single country. We refer to these as local models: models derived from global hierarchical models but adapted to be fitted using data from only one population. Beyond allowing model fitting to smaller, specific datasets, local models offer practical advantages such as faster computation, making it feasible for users to perform analyses quickly on their own computers. Additionally, local models enable estimates for different populations to be updated independently, for example, when new data become available. This approach has been used successfully in global estimation exercises for family planning and maternal mortality [@alkema_2024evol; @peterson_bayesian_2024].

A key challenge in the use of local models in global health estimation is synchronizing codebases and data flows between global and local estimation approaches. Synchronizing codebases and data flows is important because the fitting of local models relies on parameter estimates from global models, hence synchronization is important to ensure consistency across global and local models. Synchronization can be particularly challenging for modeling approaches that involve hierarchical estimation of multiple parameters, where the hierarchical structures may differ across parameters.

This paper introduces the \texttt{localhierarchy} R package designed to address these challenges by supporting the development and fitting of Bayesian hierarchical models in settings requiring both global and local estimation. The package provides R functions and Stan functions and model blocks [@stan2025] to facilitate specification of hierarchical models, to fit full global models, and to subsequently fit local models using fixed parameter values inferred from the global analysis. Through this framework, users can conveniently perform local inference informed by global context, streamlining workflows in global health estimation tasks.

This article presents a practical introduction to the \texttt{localhierarchy} package along with illustrative case studies demonstrating its applicability. The article is organized as follows. The next section introduces the modeling approach and workflow used for estimating family planning indicators, motivating the need for the \texttt{localhierarchy} functionality of fitting global and local hierarchical models. The methods section introduces the package's functionality for the estimation of one parameter at the national and subnational levels. Finally, we return to the case study of family planning estimation to present illustrative results of the application of the \texttt{localhierarchy} setup in this context.

# The Family Planning Estimation Tool (FPET) {#sec-fpet}

The Family Planning Estimation Tool (FPET) is widely used to estimate key family planning indicators in countries and regions. Key indicators include modern contraceptive use, demand for family planning, and demand satisfied, referring to the ratio of modern contraceptive use to demand. Data on such indicators is available from household surveys and routine data systems. FPET estimates are obtained from fitting a Bayesian model to available data. An illustration of FPET estimates and available data is shown in @fig-localfits for three countries in Western Africa.

![Data, estimates, and forecasts from 1970 until 2030 for FP indicators for married women in Benin (BEN), Gambia (GMB), and Ghana (GHA). Graphs show modern contraceptive use, unmet need for modern methods, demand, and demand satisfied with modern methods. Survey data are shown in colored dots with 95% confidence intervals that reflect total error variance. FPET estimates are shown in black, with grey shaded areas representing 90% credible intervals.](fig/fp_local.jpg){#fig-localfits}

At its core, the Bayesian FPET model employs transition models for demand and demand satisfied to characterize the long-term trajectories of family planning indicators over time within a population [@susmann_flexible_2025], illustrated in @fig-transition. The transition model describes changes in an indicator in terms of three principal parameters: the rate of change, the timing of the transition, and the asymptotic level (the maximum attainable level for an indicator). To allow for population-specific variation in how family planning indicators evolve, the parameters of the transition model are population-specific.

![Schematic illustration of transition model used in the modeling of family planning indicators. The transition model describes changes in an indicator (here $\eta_{c,t}$ in terms of three principal parameters: the rate of change, the level in a reference year (here labeled with $\Omega_c$), and the asymptotic level (the maximum attainable level for an indicator (here labeled with $\lambda_c$). This figure has been reproduced with permission from @susmann_flexible_2025.](fig/transition.png){#fig-transition width="476"}

Given limited country-specific information on some parameters, Bayesian hierarchical models are used to share information between populations, using hierarchical structures such as the one illustrated in \@fig-hierstruc. Specifically for family planning estimation and forecasting, a hierarchical model is used to estimate the level of demand in a reference year and the asymptote of the transition of demand from low to high values. @fig-level shows estimates of the level in the reference year at the country level for countries in Western Africa, and for the groupings used in the hierarchical model. @fig-asympt shows estimates for the asymptote. These figures show variation in levels among countries in Western Africa, informed by country-specific data. Estimates of asymptotes are similar across countries in Western Africa because countries have not yet reached the end phase of their transition; the asymptotes in Western African countries are informed by the estimate of the asymptote in sub-Saharan Africa through the hierarchical model.

<!-- figure hier structure  -->

<!-- ```{=latex} -->

<!-- \begin{figure}[h] -->

<!-- \begin{adjustbox}{max size={\textwidth}{\textheight},center} -->

<!-- %\resizebox{\textwidth}{\textwidth}{ -->

<!-- \begin{tikzpicture}[%scale=0.8, -->

<!--   box/.style={rectangle, draw, rounded corners, minimum width=2.6cm, minimum height=1cm, align=center}, -->

<!--   level0/.style={box, fill=world!40}, -->

<!--   level1/.style={box, fill=blue!20}, -->

<!--   level2/.style={box, fill=purple!20}, -->

<!--   level3/.style={box, fill=country!40, minimum width=2.2cm}, -->

<!--     level4/.style={box, fill=data!20, minimum width=2.2cm}, -->

<!--   arrow/.style={-{Latex[length=3mm]}, thick}, -->

<!--   faintarrow/.style={-{Latex[length=2mm]}, thick, opacity=0.4}, -->

<!--   background/.style 2 args={rectangle, rounded corners, draw=none, fill=#1, fill opacity=0.15, inner sep=0.5cm, fit=#2} -->

<!-- ] -->

<!-- % --- Level 0 --- -->

<!-- \node[level0] (mu0) {World}; -->

<!-- % --- Level 1 --- -->

<!-- \node[level1, below left=1cm and 3cm of mu0] (mu11) {Sub-Saharan Africa}; -->

<!-- \node[level1, right=of mu11] (mu12) {South-East Asia}; -->

<!-- \node[level1, right=of mu12] (dots1) {$\dots$}; -->

<!-- % --- Level 2 --- -->

<!-- \node[level2, below left=1cm and 0cm of mu11] (mu21) {Western Africa}; -->

<!-- \node[level2, right=of mu21] (mu22) {Eastern Africa}; -->

<!-- \node[level2, right=of mu22] (dots2) {$\dots$}; -->

<!-- % % --- Level 3 --- -->

<!-- \node[level3, below left=1cm and 0cm of mu21] (mu31) {Senegal}; -->

<!-- \node[level3, right=of mu31] (mu32) {Burkina Faso}; -->

<!-- \node[level3, right=of mu32] (dots3) {$\dots$}; -->

<!-- % % % --- Level 4 --- -->

<!-- % \node[level4, below left=1cm and 0cm of mu31] (mu41) {Data point 1}; -->

<!-- % \node[level4, right=of mu41] (mu42) {Data point 2}; -->

<!-- % \node[level4, right=of mu42] (dots4) {$\dots$}; -->

<!-- % --- Background blocks --- -->

<!-- \begin{pgfonlayer}{background} -->

<!--   \node[background={world!40}{(mu0)}] {}; -->

<!--   \node[background={blue!20}{(mu11)(mu12)(dots1)}] (bg1) {}; -->

<!--   \node[background={pink!60}{(mu21)(mu22)(dots2) }] (bg2) {}; -->

<!--  \node[background={country!40}{(mu31)(mu32)(dots3)}] (bg3) {}; -->

<!--  % \node[background={data!40}{(mu41)(mu42)(dots4)}] (bg4) {}; -->

<!-- \end{pgfonlayer} -->

<!-- % Sigma labels inside background blocks -->

<!-- \node[anchor=north west] at (bg1.east) {Major world regions}; -->

<!-- \node[anchor=north west] at (bg2.east) {Smaller world regions}; -->

<!-- \node[anchor=north west] at (bg3.east) {Countries}; -->

<!-- %\node[anchor=north west] at (bg4.east) %{Country data}; -->

<!-- % --- Arrows --- -->

<!-- \draw[arrow] (mu0.south) -- (mu11.north); -->

<!-- \draw[arrow] (mu0.south) -- (mu12.north); -->

<!-- \draw[arrow] (mu0.south) -- (dots1.north); -->

<!-- \draw[arrow] (mu11.south) -- (mu21.north); -->

<!-- \draw[arrow] (mu11.south) -- (mu22.north); -->

<!-- \draw[arrow] (mu11.south) -- (dots2.north); -->

<!-- \draw[arrow] (mu21.south) -- (mu31.north); -->

<!-- \draw[arrow] (mu21.south) -- (mu32.north); -->

<!-- \draw[arrow] (mu21.south) -- (dots3.north); -->

<!-- % \draw[arrow] (mu31.south) -- (mu41.north); -->

<!-- % \draw[arrow] (mu31.south) -- (mu42.north); -->

<!-- % \draw[arrow] (mu31.south) -- (dots4.north); -->

<!-- \end{tikzpicture}%} -->

<!-- \end{adjustbox} -->

<!-- \caption{Illustration of hierarchical grouping of countries in world regions.}\label{fig-hierstruc} -->

<!-- \end{figure} -->

<!-- ``` -->

![Illustration of hierarchical grouping of countries in world regions.](fig/worldregions.jpg){#fig-hierstruc width="631"}

![Estimates of the level of demand for major world regions (top), smaller world regions (middle) and countries in Western Africa (bottom). Point estimates and 95% credible intervals are shown.](fig/hier_level.jpg){#fig-level width="629"}

![Estimates of the asymptote for demand for major world regions (top) and countries in Western Africa (bottom). Point estimates and 95% credible intervals are shown.](fig/hier_asymptote.jpg){#fig-asympt width="652"}

The workflow used in FPET to produce country-level estimates is as follows. Firstly, the full Bayesian model is fitted to a global data base of survey data. Data base compilation is carried out by the United Nations Population Division (see [UNPD world contraceptive use website](https://www.un.org/development/desa/pd/world-contraceptive-use)) and the Track20 project (see [www.track20.org](https://www.track20.org/)). The global model fit provides information on model parameters, including hierarchical parameters, e.g., estimates of asymptotes. Subsequently, a local model can be used to produce FP estimates based on the data from one country, using information from the global model fit. The technical details for this approach are given in the next section. We return to the application of estimating family planning indicators in @sec-fpetnat.

\clearpage

# Methods

The modeling approach introduced in `localhierarchy` was motivated by applications like FPET that depend on hierarchical structures associated with national and subnational level estimation, requiring global and local models to be fit. In this section, we introduce the principle setup used for global and local hierarchical models in the context of national estimation. We use general notation and a specific example focused on national level estimation. Applications and an extension to subnational estimation are included in the use cases.

## Hierarchical model specification

Suppose we want to estimate a population parameter $\mu_r^{(l)}$ of interest, referring to a population health indicator for region $r$ at level $l$ of the hierarchy. For example, the indicator could refer to some population health indicator such as service coverage or morbidity or mortality-related outcomes. For a given level $l$, index $r$ refers to the population in a particular region indexed by $r$, for example, a subnational region, a country, or a group of countries. We assume that $\mu$ is unconstrained (possibly after a transformation has been applied) and consider the following general hierarchical model setup, see @fig-hiermodel:

\begin{align*}
  \mu_{r}^{(l)} \mid \mu^{(l-1)}_{r^\prime}, \sigma_l &\sim N(\mu^{(l-1)}_{r^\prime}, \sigma_l^2), \text{ for } l > 0,
\end{align*} where $\mu^{(l-1)}_{r^\prime}$ is the parameter value at one level higher in the hierarchy for the region $r^\prime$ that contains unit $r$. The parameter $\sigma_l$ for $l > 0$ describes variability of values of the parameter $\mu$ across geographic units at level $l$ of the hierarchy. At the top level of the hierarchy, $l = 0$, only a single parameter is estimated.

<!-- ```{=latex} -->

<!-- \begin{figure}[h] -->

<!-- \begin{adjustbox}{max size={\textwidth}{\textheight},center} -->

<!-- %\resizebox{\textwidth}{\textwidth}{ -->

<!-- \begin{tikzpicture}[ -->

<!--   box/.style={rectangle, draw, rounded corners, minimum width=2.6cm, minimum height=1cm, align=center}, -->

<!--   level0/.style={box, fill=yellow!40}, -->

<!--   level1/.style={box, fill=blue!20}, -->

<!--   level2/.style={box, fill=purple!20}, -->

<!--   level3/.style={box, fill=orange!40, minimum width=2.2cm}, -->

<!--    level4/.style={box, fill=green!20, minimum width=2.2cm}, -->

<!--   arrow/.style={-{Latex[length=3mm]}, thick}, -->

<!--   faintarrow/.style={-{Latex[length=2mm]}, thick, opacity=0.4}, -->

<!--   background/.style 2 args={rectangle, rounded corners, draw=none, fill=#1, fill opacity=0.15, inner sep=0.5cm, fit=#2} -->

<!-- ] -->

<!-- % --- Level 0 --- -->

<!-- \node[level0] (mu0) {$\mu^{(0)} \sim \mathcal{N}(0,s_0^2)$}; -->

<!-- % --- Level 1 --- -->

<!-- \node[level1, below left=2cm and 3cm of mu0] (mu11) {$\mu^{(1)}_1 \sim \mathcal{N}(\mu^{(0)},\sigma_{1}^2)$}; -->

<!-- \node[level1, right=of mu11] (mu12) {$\mu^{(1)}_2$}; -->

<!-- \node[level1, right=of mu12] (dots1) {$\dots$}; -->

<!-- % --- Level 2 --- -->

<!-- \node[level2, below left=2cm and 0cm of mu11] (mu21) {$\mu^{(2)}_1 \sim \mathcal{N}(\mu^{(1)}_1,\sigma_{2}^2)$}; -->

<!-- \node[level2, right=of mu21] (mu22) {$\mu^{(2)}_2$}; -->

<!-- \node[level2, right=of mu22] (dots2) {$\dots$}; -->

<!-- % % --- Level 3 --- -->

<!-- \node[level3, below left=2cm and 0cm of mu21] (mu31) {$\mu^{(3)}_1 \sim \mathcal{N}(\mu^{(2)}_1,\sigma_{3}^2)$}; -->

<!-- \node[level3, right=of mu31] (mu32) {$\mu^{(3)}_2$}; -->

<!-- \node[level3, right=of mu32] (dots3) {$\dots$}; -->

<!-- % % % --- Level 4 --- -->

<!-- % \node[level4, below left=2cm and 0cm of mu31] (mu41) {$\mu^{(4)}_1 \sim \mathcal{N}(\mu^{(3)}_1,\sigma_{4}^2)$}; -->

<!-- % \node[level4, right=of mu41] (mu42) {$\mu^{(4)}_2$}; -->

<!-- % \node[level4, right=of mu42] (dots4) {$\dots$}; -->

<!-- % --- Background blocks --- -->

<!-- \begin{pgfonlayer}{background} -->

<!--   \node[background={yellow!40}{(mu0)}] {}; -->

<!--   \node[background={blue!20}{(mu11)(mu12)(dots1)}] (bg1) {}; -->

<!--   \node[background={pink!60}{(mu21)(mu22)(dots2) }] (bg2) {}; -->

<!--  \node[background={orange!40}{(mu31)(mu32)(dots3)}] (bg3) {}; -->

<!-- % \node[background={green!40}{(mu41)(mu42)(dots4)}] (bg4) {}; -->

<!-- \end{pgfonlayer} -->

<!-- % Sigma labels inside background blocks -->

<!-- \node[anchor=north west] at (bg1.east) {$\sigma_{1}$}; -->

<!-- \node[anchor=north west] at (bg2.east) {$\sigma_{2}$}; -->

<!-- \node[anchor=north west] at (bg3.east) {$\sigma_{3}$}; -->

<!-- %\node[anchor=north west] at (bg4.east) {$\sigma_{4}$}; -->

<!-- % --- Arrows --- -->

<!-- \draw[arrow] (mu0.south) -- (mu11.north); -->

<!-- \draw[arrow] (mu0.south) -- (mu12.north); -->

<!-- \draw[arrow] (mu0.south) -- (dots1.north); -->

<!-- \draw[arrow] (mu11.south) -- (mu21.north); -->

<!-- \draw[arrow] (mu11.south) -- (mu22.north); -->

<!-- \draw[arrow] (mu11.south) -- (dots2.north); -->

<!-- \draw[arrow] (mu21.south) -- (mu31.north); -->

<!-- \draw[arrow] (mu21.south) -- (mu32.north); -->

<!-- \draw[arrow] (mu21.south) -- (dots3.north); -->

<!-- % \draw[arrow] (mu31.south) -- (mu41.north); -->

<!-- % \draw[arrow] (mu31.south) -- (mu42.north); -->

<!-- % \draw[arrow] (mu31.south) -- (dots4.north); -->

<!-- \end{tikzpicture} -->

<!-- \end{adjustbox} -->

<!-- \caption{General specification of a hierarchical model.}\label{fig-hiermodel} -->

<!-- \end{figure} -->

<!-- ``` -->

![General specification of a hierarchical model.](fig/hiermodel.jpg){#fig-hiermodel width="613"}

As a specific example, we consider the estimation of country-specific parameters, where countries are organized into subregions of countries (illustrated in Figure \ref{fig-hiermodel}). In this setting, using alternative notation for the same setup to indicate the level by name, the hierarchical model can be written as follows:

\begin{alignat}{2}
  \mu_c^{(\country)} &\mid \mu_{s[c]}^{(\subregion)}, \sigma_{ \country}^2 &&\sim N(\mu_{s[c]}^{(\subregion)}, \sigma_{ \country}^2), \label{eq-countryhier} \\
  \mu_s^{(\subregion)} &\mid \mu_{w[s]}^{(\region)}, \sigma_{ \subregion}^2 &&\sim N(\mu_{w[s]}^{(\region)}, \sigma_{\subregion}^2), \nonumber \\
  \mu_w^{(\region)} &\mid \mu^{(\glob)}, \sigma_{ \region}^2 &&\sim N(\mu^{(\glob)}, \sigma_{ \region}^2), \nonumber
\end{alignat} where $c =1,\dots,C$ refers to the country index, $s[c] = 1, .., S$ to the subregion index of country $c$, and $w[s[c]] = 1, .., W$ to the region index of subregion $s[c]$. The parameter $\mu^{(\glob)}$ is the global mean for the parameter of interest, e.g., a global mean for service coverage or mortality. The parameters $\sigma_{ \country}$, $\sigma_{ \subregion}$, and $\sigma_{ \region}$ describe variability in the parameter of interest across countries, subregions, and regions, respectively.

```{=html}
<!-- Here, if $\mu^{(\glob)}$ has prior $\mu^{(\glob)} \sim N(0, s_{\mu, global}^2)$, then $$\mu_c =  s_{global}\cdot \gamma_{global} + \sigma_{ region}\cdot \gamma_{r[s[c]]]}^{(
egion)} + \sigma_{ subregion}\cdot\gamma_{s[c]}^{(\subregion)} + \sigma_{ country}\cdot\gamma_{ c},$$ with $\gamma \sim N(0,1)$ for each gamma (one global, $R$ regions, $S$ subregions, $C$ countries). -->
```

## Local hierarchical models

We use the term local hierarchical models to refer to a hierarchical model in which a subset of parameters have been fixed at posterior mean estimates obtained from a fit of the model to a larger data set. A typical workflow for local estimation of national level outcomes is illustrated in @fig-workflow. For national estimation using the model given by Eq.\ref{eq-countryhier}, the user starts by fitting a global model, using a global data base and estimating all parameters in a hierarchical model. In a local model, data from one country are used and parameters that are not country-specific are fixed using parameter estimates from the global model fit.

<!-- ```{=latex} -->

<!-- \begin{figure}[h] -->

<!-- \begin{adjustbox}{max size={\textwidth}{\textheight},center} -->

<!-- \begin{tikzpicture}[ -->

<!--   box/.style={rectangle, draw, thick, rounded corners, minimum width=6cm, align=left, inner sep=6pt}, -->

<!--   databox/.style={box, fill=data!20}, -->

<!--   modelbox/.style={box, fill=param!20}, -->

<!--   arrowdata/.style={-{Latex[length=3mm]}, thick, data}, -->

<!--   arrowparam/.style={-{Latex[length=3mm]}, thick, param!80}, -->

<!--   font=\sffamily -->

<!-- ] -->

<!-- % --- Nodes --- -->

<!-- \node[databox] (globaldata) {Global data base of country data}; -->

<!-- \node[modelbox, below=1cm of globaldata] (globalmodel) {% -->

<!--   Global national modeling:\\ -->

<!--   Estimate all parameters in hierarchical model, e.g., \\ -->

<!-- \( -->

<!--   \begin{aligned} -->

<!-- \mu_w^{(region)} &\sim N(\mu^{(global)}, \sigma_{ region}^2),\\ -->

<!-- \mu_s^{(subregion)} &\sim N(\mu_{w[s]}^{(region)}, \sigma_{ subregion}^2), \\ -->

<!-- \mu_c^{(country)} &\sim N(\mu_{s[c]}^{(subregion)}, \sigma_{ country}^2),  \end{aligned} -->

<!-- \) -->

<!-- }; -->

<!-- \node[modelbox, below=1cm of globalmodel] (localmodel) {% -->

<!--   Local national modeling:\\ -->

<!--   Estimate national parameters only, \\ -->

<!--   fix parameter estimates at higher levels of the hierarchy \\i.e., $\mu_c^{(country)}$ with $\mu_c^{(country)} \sim N(\hat{\mu}_{s[c]}^{(subregion)}, \hat{\sigma}_{ country}^2).$ -->

<!-- }; -->

<!-- % --- Data arrow (down then right) --- -->

<!-- \draw[arrowdata] (globaldata.south) -- (globalmodel.north); -->

<!-- \draw[arrowdata] (globaldata.east) ++(0,0) -- ++(4.5,0) |- (localmodel.east) -->

<!-- node[midway,above] {Data for one country}; -->

<!-- % --- Parameter arrow --- -->

<!-- \draw[arrowparam] (globalmodel.south) -- (localmodel.north); -->

<!-- % --- Legend --- -->

<!-- % \node[arrowparam, below=1.2cm of localmodel.west, anchor=west] (leg1) {};  -->

<!-- % \node[right=0.3cm of leg1] {\textcolor{param}{$\rightarrow$ Parameter estimates}}; -->

<!-- \node[below=1cm of localmodel](parameter) {\textcolor{param}{$\rightarrow$ Parameter estimates}}; -->

<!-- \node[right=1cm of parameter] {\textcolor{data}{$\rightarrow$ Data}}; -->

<!-- \end{tikzpicture} -->

<!-- \end{adjustbox} -->

<!-- \caption{Workflow for global and local national modeling. }\label{fig-workflow} -->

<!-- \end{figure} -->

<!-- ``` -->

![Workflow for global and local national modeling.](fig/workflow.jpg){#fig-workflow width="614"}

A local model is derived from a global one by fixing parameters. Continuing with the specific example, an example local model to produce country estimates using data from one country alone has the following setup:

$$\mu_c^{(\country)} \sim N(\hat{\mu}_{s[c]}^{(\subregion)}, \hat{\sigma}_{ \country}^2),$$

replacing the hierarchical mean and variances by point estimates $\hat{\mu}_{s[c]}^{(\subregion)}$ and $\hat{\sigma}_{ \country}^2$, respectively. Details are given in the implementation section.

The `localhierachy` package provides a general implementation of local models by facilitating the fixing of subsets of parameters. Continuing with the general notation introduced above, in the package, a local model for one parameter of level $l$ is derived by fixing $\sigma_k$ for $k=1, ..., l$ and fixing $\mu_{\cdot}^{(k)}$ for $k = 1, .., l-1$ at posterior means derived from a global fit. More generally, if a model was fitted using data up to level $l$, the user can create a local model by fixing $\sigma_k$ at all levels $k$ up to some chosen level $K_{\sigma}$. Similarly, the $\mu^{(k)}$ parameters can be fixed at all levels $k$ up to a level $K_{\mu} \leq K_{\sigma}$.

## Implementation {#sec-implementation}

The `localhierarchy` R package contains R functions and example Stan model files to fit global and local hierarchical models. The package is set up to allow for users to incorporate the global-local hierarchy setup into their own project. For a given parameter and hierarchical model specification, the package functions enable processing of data to produce Stan input data for global and local models, Stan model components that work for both global as well as local models, and R functions for postprocessing of model outputs to check results and produce summary files of global models for use in local models.

In a typical work flow, a user first fits a global model, followed by local ones. Worked examples are given in the use cases in @sec-nationalusecase and @sec-subnatusecase. The global and local models in these examples are fitted using the `localhierarchy` wrapper function `fit_model_localhierarchy`, using its arguments to specify a hierarchical model, data, and, for local fits, pass on outputs from the global model. The wrapper function calls R functions to process data and prepare Stan input data, read in a Stan model, fit the model, and to postprocess the results.

The package includes a user-friendly specification of hierarchical model structures, and associated specification of fixed parameters for local runs. A worked example is given in the first use case (@sec-nationalusecase). Briefly, if a user wants to specify a hierarchical model with the levels world, regions, subregion, and country, <!-- country parameters $\mu_c^{(\country)} =  s_{global}\cdot \gamma_{global} + \sigma_{ region}\cdot \gamma_{r[s[c]]]}^{(
egion)} + \sigma_{ subregion}\cdot\gamma_{s[c]}^{(\subregion)} + \sigma_{ country}\cdot\gamma_{ c}$,  --> using a dataset with information on these groupings, with naming `region`, `subregion`, and `country`, in the R functions, the user can specify the hierarchical model as follows:

```{r, eval = FALSE}
hierarchical_level <- c("intercept",  "region", "subregion", "country")
```

The first level is the intercept, which is the global mean, followed by the region, subregion, and country levels. The user can then specify a local model for one country by fixing parameters at different levels, using the `hierarchical_sigmas_fixed` and `hierarchical_terms_fixed` arguments in the `fit_model_localhierarchy` function. For example, if the $\sigma$ parameters are to be fixed up to the country level and if the $\mu$ terms are to be fixed up to the subregion, the user can encode this as follows:

```{r, eval = FALSE}
hierarchical_sigmas_fixed <- c("intercept",  "region", "subregion", "country")
hierarchical_terms_fixed <- c("intercept",  "region", "subregion")
```

Note that even though there is no $\sigma$ at the intercept level, this term is always included in the `hierarchical_sigmas_fixed` vector.

The parameterization used in Stan is a non-centered parameterization. In general notation, for $l>0$, non-centered parameterization refers to writing mean parameters as deviations from higher-level group means: \begin{align*}
  \mu_r^{(l)} &= \mu^{(l-1)} + \sigma_l \cdot \gamma_{r}^{(l)},
\end{align*} where $\gamma_r^{(l)} \sim N(0, 1)$. Applied sequentially, and if $\mu^{(0)} \sim N(0,s_{\glob})$ with prior standard deviation $s_{\glob}$, we get \begin{align*}
  \mu_r^{(l)} &= s_{\glob}\cdot\gamma^{(0)} + \sum_{k=1}^{l} \sigma_k \cdot \gamma_{r^\prime}^{(k)},
\end{align*} where $r^\prime$ now refers more generally to the index of the unit containing the lower-level group. For the specific example of country parameters, the non-centered parameterization is given by \begin{align*}
  \mu_c^{(\country)} =  s_{\glob} \cdot {\gamma}^{(\glob)} + {\sigma}_{\region}\cdot {\gamma}_{w[s[c]]]}^{(\region)} + {\sigma}_{\subregion}\cdot{\gamma}_{s[c]}^{(\subregion)} + {\sigma}_{\country}\cdot\gamma_{c}^{(\country)}.
\end{align*}

Implementation is based on a model matrix. For our model given by the equation above, the following matrix multiplication is used to obtain the vector of $\mu_c^{(\country)}$s: $$(\mu_1^{(\country)}, ..., \mu_c^{(\country)}) = M\cdot (\eta_1, ..., \eta_{1+R+S+C})',$$ where matrix $M$ is a sparse matrix with 1s and 0s, and $(\eta_1, ..., \eta_{1+R+S+C})$ refers to the vector of the product of the standard deviation terms and $\gamma$ terms, i.e., $\eta_1 = s_{\glob}\cdot \gamma_{\glob}, \eta_2 = \sigma_{ \region} \cdot \gamma_{ 1}^{(\region)}, ..., \eta_{1+W+S+C} = \sigma_{ \country}\cdot\gamma_{ C}^{(\country)}$. When estimating a subset of parameters in a local model, the values of $\sigma$s and $\gamma$s are fixed to point estimates (posterior means) from a global fit. For example, for a national model, we get \begin{align*}
  \mu_c = s_{\glob} \cdot \hat{\gamma}_{\glob} + 
          \hat{\sigma}_{ \region} \cdot \hat{\gamma}_{w[s[c]]]}^{(\region)} + 
          \hat{\sigma}_{ \subregion} \cdot \hat{\gamma}_{s[c]}^{(\subregion)} + 
          \hat{\sigma}_{ \country} \cdot \gamma_{c}^{(\country)}.
\end{align*}

## Operation

`localhierarchy` is a publicly available R package stored on Github. For usage, installation of R (≥4.5.1), Stan (≥2.37.0), and CmdStanR (≥ 0.9.0) are required [@WeloveR; @stan2025; @cmdstanr_2025]. The `localhierarchy` package can be installed from the Github repository. Package dependencies are listed in the package DESCRIPTION file and will be automatically installed upon installing the main package. There are no minimum RAM, CPU, or HARDDRIVE requirements apart from what is necessary to store model runs, which varies case-by-case.

<!-- The `localhierarchy` package can be installed with one of two methods: (1) direct install from Github repository using the `install_ github()` API from the devtools package (Wickham et al., 2020); (2) install from the package binary using the base R function `install.package()`. Package dependencies are listed in the package DESCRIPTION file and will be automatically installed upon installing the main package. There are no minimum RAM, CPU, or HARDDRIVE requirements apart from what is necessary to store model runs, which varies case-by-case. -->

# Use case: National estimation {#sec-nationalusecase}

We present a detailed use case of the `localhierarchy` package using simulated data, followed by an application of that functionality in FPET.

## Detailed example using simulated data

### Simulation setup

The simulation setup is summarized in @fig-simusetup, top and center panels. Simulation of subnational data is discussed in a later section.

<!-- ```{=latex} -->

<!-- \begin{figure}[h] -->

<!-- \fbox{\begin{adjustbox}{max size={\textwidth}{\textheight},center} -->

<!-- \begin{tikzpicture}[ -->

<!--   box/.style={rectangle, draw, rounded corners, minimum width=2cm, minimum height=1cm, align=center}, -->

<!--   level0/.style={box, fill=yellow!40}, -->

<!--   level1/.style={box, fill=orange!40}, -->

<!--   level2/.style={box, fill=green!20}, -->

<!--   arrow/.style={-{Latex[length=3mm]}, thick}, -->

<!--   faintarrow/.style={-{Latex[length=2mm]}, thick, opacity=0.4}, -->

<!--   background/.style 2 args={rectangle, rounded corners, draw=none, fill=#1, fill opacity=0.15, inner sep=0.5cm, fit=#2} -->

<!-- ] -->

<!-- % --- Level 0 --- -->

<!-- \node[level0] (mu0) {$\mu^{(\glob)} \sim \mathcal{N}(0,s_\glob^2)$}; -->

<!-- % --- Level 1 --- -->

<!-- \node[level1, below left=1.5cm and 3cm of mu0] (mu11) {$\mu^{(\country)}_1 \sim \mathcal{N}(\mu^{(\glob)},\sigma_{\country}^2)$}; -->

<!-- \node[level1, right=of mu11] (mu12) {$\mu^{(\country)}_2$}; -->

<!-- \node[level1, right=of mu12] (dots1) {$\dots$}; -->

<!-- % --- Level 2 --- -->

<!-- \node[level2, below left=1.5cm and 0cm of mu11] (mu21) {$\mu^{(\subnat)}_1 \sim \mathcal{N}(\mu^{(\country)}_1,\sigma_{\subnat}^2)$}; -->

<!-- \node[level2, right=of mu21] (mu22) {$\mu^{(2)}_2$}; -->

<!-- \node[level2, right=of mu22] (dots2) {$\dots$}; -->

<!-- % --- Background blocks --- -->

<!-- \begin{pgfonlayer}{background} -->

<!--   \node[background={yellow!40}{(mu0)}] {}; -->

<!--   \node[background={orange!40}{(mu11)(mu12)(dots1)}] (bg1) {}; -->

<!--   \node[background={green!40}{(mu21)(mu22)(dots2) }] (bg2) {}; -->

<!-- \end{pgfonlayer} -->

<!-- % Sigma labels inside background blocks -->

<!-- \node[anchor=north west] at (bg1.east) {$\sigma_{\country}$, country}; -->

<!-- \node[anchor=north west] at (bg2.east) {$\sigma_{\subnat}$, subnational region}; -->

<!-- % --- Arrows --- -->

<!-- \draw[arrow] (mu0.south) -- (mu11.north); -->

<!-- \draw[arrow] (mu0.south) -- (mu12.north); -->

<!-- \draw[arrow] (mu0.south) -- (dots1.north); -->

<!-- \draw[arrow] (mu11.south) -- (mu21.north); -->

<!-- \draw[arrow] (mu11.south) -- (mu22.north); -->

<!-- \draw[arrow] (mu11.south) -- (dots2.north); -->

<!-- \end{tikzpicture} -->

<!-- \end{adjustbox}} -->

<!-- % local model nat -->

<!-- \fbox{\begin{adjustbox}{max size={\textwidth}{\textheight},center} -->

<!-- \begin{tikzpicture}[ -->

<!--   box/.style={rectangle, draw, rounded corners, minimum width=2cm, minimum height=1cm, align=center}, -->

<!--   level0/.style={box, fill=yellow!40}, -->

<!--   level1/.style={box, fill=orange!40}, -->

<!--   level2/.style={box, fill=green!20}, -->

<!--     data/.style={box, fill=gray!20}, -->

<!--   arrow/.style={-{Latex[length=3mm]}, thick}, -->

<!--   faintarrow/.style={-{Latex[length=2mm]}, thick, opacity=0.4}, -->

<!--   background/.style 2 args={rectangle, rounded corners, draw=none, fill=#1, fill opacity=0.15, inner sep=0.5cm, fit=#2} -->

<!-- ] -->

<!-- \node[level1] (mu0) {$\mu^{(\country)}_1$}; -->

<!-- % --- Level 1 --- -->

<!-- \node[data, below left=1.5cm and 3cm of mu0] (mu11) {$y^{(country)}_1 \sim \mathcal{N}(\mu^{(\country)}_1,\sigma_{y}^2)$}; -->

<!-- \node[data, right=of mu11] (mu12) {$y^{(country)}_2$}; -->

<!-- \node[data, right=of mu12] (dots1) {$\dots$}; -->

<!-- % --- Background blocks --- -->

<!-- \begin{pgfonlayer}{background} -->

<!--   \node[background={gray!40}{(mu11)(mu12)(dots1)}] (bg1) {}; -->

<!-- \end{pgfonlayer} -->

<!-- % Sigma labels inside background blocks -->

<!-- \node[anchor=north west] at (bg1.east) {$\sigma_{y}$, country data for first country}; -->

<!-- % --- Arrows --- -->

<!-- \draw[arrow] (mu0.south) -- (mu11.north); -->

<!-- \draw[arrow] (mu0.south) -- (mu12.north); -->

<!-- \draw[arrow] (mu0.south) -- (dots1.north); -->

<!-- \end{tikzpicture} -->

<!-- \end{adjustbox}} -->

<!-- % local model subnat -->

<!-- \fbox{ -->

<!-- \begin{adjustbox}{max size={\textwidth}{\textheight},center} -->

<!-- \begin{tikzpicture}[ -->

<!--   box/.style={rectangle, draw, rounded corners, minimum width=2cm, minimum height=1cm, align=center}, -->

<!--   level0/.style={box, fill=yellow!40}, -->

<!--   level1/.style={box, fill=orange!40}, -->

<!--   level2/.style={box, fill=green!20}, -->

<!--     data/.style={box, fill=gray!20}, -->

<!--   arrow/.style={-{Latex[length=3mm]}, thick}, -->

<!--   faintarrow/.style={-{Latex[length=2mm]}, thick, opacity=0.4}, -->

<!--   background/.style 2 args={rectangle, rounded corners, draw=none, fill=#1, fill opacity=0.15, inner sep=0.5cm, fit=#2} -->

<!-- ] -->

<!-- % keep same colors so now color of level 1 at top  -->

<!-- \node[level2] (mu0) {$\mu^{(\subnat)}_1$}; -->

<!-- % --- Level 1 --- -->

<!-- \node[data, below left=1.5cm and 3cm of mu0] (mu11) {$y^{(subnat)}_1 \sim \mathcal{N}(\mu^{(\subnat)}_1,\sigma_{y}^2)$}; -->

<!-- \node[data, right=of mu11] (mu12) {$y^{(subnat)}_2$}; -->

<!-- \node[data, right=of mu12] (dots1) {$\dots$}; -->

<!-- % --- Background blocks --- -->

<!-- \begin{pgfonlayer}{background} -->

<!--   \node[background={gray!40}{(mu11)(mu12)(dots1)}] (bg1) {}; -->

<!-- \end{pgfonlayer} -->

<!-- % Sigma labels inside background blocks -->

<!-- \node[anchor=north west] at (bg1.east) {$\sigma_{y}$, subnational data for first region}; -->

<!-- % --- Arrows --- -->

<!-- \draw[arrow] (mu0.south) -- (mu11.north); -->

<!-- \draw[arrow] (mu0.south) -- (mu12.north); -->

<!-- \draw[arrow] (mu0.south) -- (dots1.north); -->

<!-- \end{tikzpicture} -->

<!-- \end{adjustbox}} -->

<!-- \caption{Diagram of simulation settings. Top: Hierarchical model for generating country and subnational parameters. Center: Data generating mechanism for national data, illustrated for the first country. Bottom: Data generating mechanism for subnational data, illustrated for the first subnational region (used only in Section 5).}\label{fig-simusetup} -->

<!-- \end{figure} -->

<!-- \clearpage -->

<!-- ``` -->

![Diagram of simulation settings. Top: Hierarchical model for generating country and subnational parameters. Center: Data generating mechanism for national data, illustrated for the first country. Bottom: Data generating mechanism for subnational data, illustrated for the first subnational region (used only in Section 5).](fig/simusetup.jpg){#fig-simusetup width="618"}

The top panel in Figure \ref{fig-simusetup} indicates the hierarchical model considered. For national level estimation, we consider countries to be grouped in the world, i.e., $\mu_c^{(\country)}|\mu^{(\glob)}, \sigma_{ \country} \sim N(\mu^{(\glob)}, \sigma_{ \country}^2)$. The center panel introduces the likelihood function for national data, given by a normal likelihood with constant variance: $$y_i^{(\country)}|\mu_{c[i]}^{(\country)}, \sigma_y^2 \sim N(\mu_{c[i]}^{(\country)}, \sigma_y^2),$$ where $c[i]$ refers to the country of country observation $i$. We chose simple normal densities as data generating mechanisms in the simulation, to focus the modeling on the hierarchical model and the `localhierarchy` functionality as opposed to the data model aspects of modeling. In practice, the data model can be set by the user to reflect actual data generating mechanisms, for example, by using a binomial likelihood, considering transformed outcomes, or accounting for sampling errors for observations that were obtained from a complex survey design.

Simulated data were generated using `simulate_multilevel_data` function. We simulate a set of model parameters, setting $\mu^{(\glob)} = 0$, and $\sigma_{\country} = 0.5$, creating 30 countries, and national data, using $\sigma_y = 0.1$. The function call is as follows (note that the function also generates parameters and data at the subnational level, these are used in Section 5):

```{r}
dat_all <- simulate_multilevel_data(
  n_levels = 2,
  n_units_perlevel = c(30, 20),
  sigma_perlevel = c(0.5, 0.2), # national and subnational level
  mu_global = 0,
  add_data = TRUE,
  n_data = 10,
  sigma_y = 0.1, # used for national and subnational data
  add_data1levelup = TRUE
)
dat_nat <- dat_all$data_1levelup
```

In the simulated data, `level1` refers to the country level. The data sets contain the simulated parameters (`eta`; the deviation away from the global mean) and data (`y`):

```{r}
dat_nat |> dplyr::select(level1,  mu_global, level1_eta, y)
```

### Model fitting

We can fit global and local models using the `fit_model_localhierarchy` wrapper function, as shown later in this section. We first provide implementation details, using the main functions of the package and excerpts from the Stan model.

For model fitting, the first step is to specify a hierarchical structure, using `intercept` and names included in the survey data. For national level estimation, `level1` is the name used in the data:

```{r}
hierarchical_level <- c("intercept",  "level1")
```

Input data are processed using the function `get_geo_unit_index_data`. This function obtains unique hierarchical groupings from the input data and assigns an index `c` to each unique grouping:

```{r}
geo_unit_index <- get_geo_unit_index_data(
  dat_nat,
  hierarchical_levels = hierarchical_level,
  area = "level1"
)
geo_unit_index
```

The second step in the processing is to create a hierarchical data object, using the function `hierarchical_data`. This function outputs a list with various components associated with the parameterization of the hierarchical parameters, used in the Stan model and for further post-processing:

```{r}
hier_data <- hierarchical_data(geo_unit_index, hierarchical_level)
names(hier_data)
```

Elements include the model matrix and other elements are used to make a link between columns in the model matrix, or equivalently, indices in the vector $\eta$, and the hierarchical groupings. The model matrix $M$, as introduced in @sec-implementation, is as follows:

```{r}
dim(hier_data$model_matrix$matrix)
hier_data$model_matrix$matrix[1:10, 1:10]
```

All of this information is passed to the function `hierarchical_param_stan_data` to produce inputs needed in the Stan model fitting. This function outputs a named list with Stan input data relevant to the hierarchical setup:

```{r}
hier_stan_data <- hierarchical_param_stan_data(
  param_name = "mu",
  param_data = hier_data
)
names(hier_stan_data)
```

For example, in this setting, we only have to estimate one $\sigma_{\mu}$, and no $\sigma_{\mu}$ is fixed, as recorded in the `n_sigma_estimate` and `n_sigma_fixed` elements of the Stan input data:

```{r}
hier_stan_data$mu_n_sigma_estimate
hier_stan_data$mu_n_sigma_fixed
```

We can use the function `fit_model_localhierarchy` to fit the model as specified so far. Details are included in the appendix (@sec-helpfilefitmodel). The argument `runstep` is used to define the type of model, setting it to `"global_national"` results in fitting a model to all data without fixing any parameters. Other arguments include the hierarchical level specification, the area, and survey data. When calling the function, print statements are used to inform the user of key points related to the model fit:

```{r}
global_fit <- fit_model_localhierarchy(
  runstep = "global_national",
  hierarchical_level = hierarchical_level,
  area = "level1",
  survey_df = dat_nat
)
```

When doing model fitting, the same Stan model is used for both global and local models. Excerpts from the Stan model are included in Appendix 1.

The fitting returns posterior samples and other meta information about the fit.

```{r}
names(global_fit)
```

The `post_summ` object contains posterior means for relevant model parameters. For example:

```{r}
global_fit$post_summ |> 
  dplyr::filter(variable_no_index == "mu_sigma")
```

A local fit can be estimated by passing on the global fit object to the wrapper function and including data for countries of interest. Here we do local runs for all countries, by including the entire data set, and specify what to fix using the `runstep` argument:

```{r}
fit_local <- fit_model_localhierarchy(
  runstep = "local_national",
  global_fit = global_fit,
  area = "level1",
  survey_df = dat_nat
)
```

When doing a local national run with `runstep = "local_national"`, the hierarchical levels are taken from the global fit, and non-country-specific parameters are fixed. This is indicated in the print statements above. In the wrapper function, relevant code excerpts for `"local_national"` runs are as follows:

```{r}
hierarchical_level <- global_fit$hierarchical_level
hierarchical_level_terms_fixed <- 
  hierarchical_level[1:(length(hierarchical_level)-1)]
hierarchical_level_sigmas_fixed <- 
  hierarchical_level[1:(length(hierarchical_level))]
```

When doing a local fit, the same R functions and Stan model are used as introduced above but Stan input data is updated to fix a subset of parameters. Specifically, when producing Stan input data, the following function call is used:

```{r}
hier_stan_data_local <- hierarchical_param_stan_data(
  param_name = "mu",
  param_data = hier_data, 
  # information to fix parameters 
  global_fit = global_fit,
  hierarchical_terms_fixed = hierarchical_level_terms_fixed, 
  hierarchical_sigmas_fixed = hierarchical_level_sigmas_fixed
)
```

where the arguments `hierarchical_terms_fixed` and `hierarchical_sigmas_fixed` are used to fix the $\mu$ at the intercept-level and the $\sigma$s up to and including the country-level. Indeed, when comparing the outputs of this function call to the one for a global fit, we find that the country $\sigma$ is fixed at the value from the global fit:

```{r}
hier_stan_data_local$mu_n_sigma_fixed
hier_stan_data_local$mu_n_sigma_estimate
hier_stan_data_local$mu_sigma_fixed
```

In addition to fixing parameters of hierarchical models, other non-country-specific parameters can be fixed as well. In this example, $\sigma_y$ is a global parameter that is fixed at the posterior mean from the global run for use in local runs.

### Processing model fits

The package includes several functions to produce and check outputs. The function `posterior_summary_hierparam` is used to summarize posterior draws for hierarchical parameters, to produce summaries of $\mu$ at any level of interest. It takes a fitted model object and a parameter name as input and returns a list with each entry referring one level, and the results (e.g., estimates for $\mu$ estimates) for that level. Here we obtain these results for the global and local model:

```{r, message=FALSE, warning=FALSE}
res_global <- posterior_summary_hierparam_localhierarchy(
  fit = global_fit, parname = "mu")
res_local <- posterior_summary_hierparam_localhierarchy(
  fit = fit_local, parname = "mu")
```

Example output for the global model is as follows:

```{r}
res_local$level1
```

The column `name` includes the country names, given by simple indices in this simulation. The column `quant` above refers to posterior means and upper and lower bounds of 95% credible intervals. We can create plots to show outputs, for example for the first 4 countries:

```{r}
plots <- plot_posterior_summaries_localhierarchy(
  res = res_global, 
  modelname1 = "global",
  hierarchy_select = "level1",
  areas_select = unique(res_local$level1$name)[1:4]
)

plots$level1
```

By plotting results from global and local models, we can check how estimates compare and how values have been fixed in the local runs. For example, here we see how country estimates compare between global and local models:

```{r}
plots <- plot_posterior_summaries_localhierarchy(
  res = res_local, 
  modelname1 = "local",
  res2 = res_global, 
  modelname2 = "global", 
  hierarchy_select = "level1",
  areas_select = unique(res_local$level1$name)[1:4]
)

plots$level1
```

Estimates are similar, as expected.

When visualizing higher levels, we see how parameters were fixed in the local model:

```{r}
plots <- plot_posterior_summaries_localhierarchy(
  res = res_local, 
  modelname1 = "local",
  res2 = res_global, 
  modelname2 = "global"
)

plots$intercept 
```

We can also create plots for the $\gamma$s (`mu_raw`s):

```{r, message=FALSE, warning=FALSE}
plots <- plot_muraw_localhierarchy(fit = global_fit, parname = "mu")
```

This gives a list with plots, including summary plots and plots with priors and posteriors. For example, the figures below show the first 30 $\gamma$s, followed by the prior-posterior densities for the first $\gamma$ (referring to the intercept).

```{r}
plots[["summary_plots"]][[1]]
```

```{r}
plots[["plots_allmuraw"]][[1]]
```

Plots with prior and posterior densities of the $\sigma$s can be produced as well:

```{r}
plot_prior_post_sigmas_localhierarchy(fit = global_fit, parname = "mu")
```

## Application: National estimation of family planning indicators using FPET {#sec-fpetnat}

For family planning estimation, a local model fitting approach was motivated by the need to enable country monitoring and evaluation (M&E) officers to produce estimates for their countries, as part of the Track20 project [@alkema_2024evol]. The Track20 project works to build the capacity of countries to generate and use data to inform their programming, improve impact, and accelerate progress toward their FP goals. One of the pillars of this approach is the cultivation of a network of M&E officers dedicated to increasing the quality and use of FP data. We developed the family planning estimation tool (FPET) as a local version of a global family planning model, for use by the M&E officers.

For local estimation of family planning indicators, the Bayesian model described in @sec-fpet is used. Specifically, hierarchical models are used for estimation of transition model parameters. The workflow used for estimating family planning indicators at the national level is based on model fitting in several steps, including the estimation of long-term trends in the first step, the estimation of all model parameters related to modern contraceptive use in a second step, the addition of information on the use of traditional methods of contraception in a third step, followed by local model fitting to produce estimates for all indicators of interest. The `localhierarchy` functionality is incorporated in the family planning modeling code base such that all steps are run with the same code base, and parameters can be passed from one model fit to another. Full details on this workflow and model specification are described elsewhere [@alkema_2024evol]. As an illustration, @fig-allfits shows global and local fits for modern contraceptive use, demand, and demand satisfied for selected countries in Western Africa. The global fit in red corresponds closely to the local fits, shown in green.

![Data, estimates, and forecasts from 1970 until 2030 for FP indicators for married women in in Benin (BEN), Gambia (GMB), and Ghana (GHA). FPET estimates are shown in in colored lines (red for global, green for local), with shaded areas representing 90% credible intervals. Survey data are shown in colored dots with 95% confidence intervals that reflect total error variance.](fig/fpet_localglobal.jpg){#fig-allfits}

<!-- ```{r} -->

<!-- #| fig-height: 9 -->

<!-- #| fig-width: 7 -->

<!-- #| echo: false -->

<!-- #| label: fig-allfits -->

<!-- #| fig-cap: "Data, estimates, and forecasts from 1970 until 2030 for FP indicators for married women in in Benin (BEN), Gambia (GMB), and Ghana (GHA). FPET estimates are shown in in colored lines (red for global, green for local), with shaded areas representing 90% credible intervals. Survey data are shown in colored dots with 95% confidence intervals that reflect total error variance." -->

<!-- plots <- readRDS("outputfpet_localglobalfits.rds") -->

<!-- plots[[1]] /  plots[[2]]/ plots[[3]] # Stack three plots vertically -->

<!-- ``` -->

\clearpage

# Use case 2: Subnational estimation {#sec-subnatusecase}

## Workflow for nationally-informed subnational estimation

For many global health applications, subnational estimation is of interest to inform policy and programmatic decision making at a more local level. If data are limited, models can be considered to share information across regions. We consider here the use of hierarchical models for an indicator of interest. The `localhierarchy` package can be used to fit subnational hierarchical models, following the same principles as for national estimation or through an updated approach. Just as for national-level hierarchical modeling, the starting point for subnational hierarchical modeling is to specify a hierarchical modeling structure for the subnational regions. When following the same principles as for national-level hierarchical modeling, a global model can be fitted to a global data base of subnational data, followed by local models for subnational regions.

In addition to a standard approach to subnational modeling, functionality in the `localhierarchy` package can also be used to fit subnational models that are informed by national level data and estimation, referred to here as *nationally-informed subnational estimation* (NISE). This approach is useful when subnational data are limited, for example, in terms of the number of countries with subnational data, the number of subnational regions with data, the number of observations per subnational region, or due to uncertainty associated with subnational data. An example is given in the case study on family planning estimation, where national level data are available for a large number of country-years while a global subnational data set is more limited in terms of the number of country-years included.

The approach followed in NISE is illustrated in @fig-nise. In the NISE approach, the first step is to fit a model to a global data base with national-level data, to obtain estimates of model parameters up to and including national level parameters. This national-level model fit isthen used in a global subnational fit to a global data base of subnational data. Specifically, in the global subnational fitting step, national level parameters are fixed at point estimates from the global national fit, i.e., $\hat{\sigma}_{ l}$ and $\mu_{\cdot}^{(l)}$ for level $l$ up to the country level. Finally, in a third step, local models can be fitted, using fixed values from the global subnational fit. In the remainder of this section, we illustrate this approach using simulated data, and present an application of this approach for family planning estimation.

<!-- ```{=latex} -->

<!-- \begin{figure}[h] -->

<!-- \begin{adjustbox}{max size={\textwidth}{\textheight},center} -->

<!-- \begin{tikzpicture}[ -->

<!--   box/.style={rectangle, draw, thick, rounded corners, minimum width=2.5cm, align=left, inner sep=6pt}, -->

<!--   eqbox/.style={box}, -->

<!--   databox/.style={box, fill=data!20}, -->

<!--   modelbox/.style={box, fill=param!20}, -->

<!--   arrowdata/.style={-{Latex[length=3mm]}, thick, data}, -->

<!--   arrowparam/.style={-{Latex[length=3mm]}, thick, param!80}, -->

<!--   font=\sffamily -->

<!-- ] -->

<!-- % --- Nodes --- -->

<!-- \node[eqbox](model){ -->

<!-- Example subnat. hierarchical model:\\ -->

<!-- \( -->

<!--   \begin{aligned} -->

<!-- \mu_w^{(\region)} &\sim N(\mu^{(\glob)}, \sigma_{ \region}^2),\\ -->

<!-- \mu_s^{(\subregion)} &\sim N(\mu_{w[s]}^{(\region)}, \sigma_{ \subregion}^2), \\ -->

<!-- \mu_c^{(\country)} &\sim N(\mu_{s[c]}^{(\subregion)}, \sigma_{ \country}^2),  \\ -->

<!-- \mu_r^{(\subnat)} &\sim N(\mu_{c[r]}^{(\country)}, \sigma_{ \subnat}^2),  \\ -->

<!-- \end{aligned} -->

<!-- \) -->

<!-- }; -->

<!-- \node[databox, right=5cm of model.north] (globaldata) {Global data base of country data}; -->

<!-- \node[modelbox, below=1cm of globaldata] (globalmodel) {% -->

<!--   Global national modeling:\\ -->

<!--   Estimate all parameters in hierarchical \\ model  -->

<!--   $\leq$ country level  -->

<!-- }; -->

<!-- \node[modelbox, below=1cm of globalmodel] (subglobalmodel) {% -->

<!--   Global subnational modeling:\\ -->

<!--   Estimate subset of parameters in \\ hierarchical model,  -->

<!--   i.e., $\sigma_{ subnat}$ -->

<!-- }; -->

<!-- \node[databox, left=1cm of subglobalmodel] (globalsubdata) {Global data base\\ of subnational data}; -->

<!-- \node[modelbox, below=1cm of subglobalmodel] (localmodel) {% -->

<!--   Local subnational modeling:\\ -->

<!--   Estimate subnational parameters only, \\i.e., $\mu_r^{(subnat)}$ in $\mu_r^{(subnat)} \sim N(\hat{\mu}_{c[r]}^{(country)}, \hat{\sigma}_{ subnat}^2).$ -->

<!-- }; -->

<!-- % --- Data arrow  --- -->

<!-- \draw[arrowdata] (globaldata.south) -- (globalmodel.north); -->

<!-- \draw[arrowdata] (globaldata.east) ++(0,0) -- ++(1.5,0) |- (localmodel.east) -->

<!-- node[midway,above] {}; -->

<!-- \draw[arrowdata] (globaldata.east) ++(0,0) -- ++(1.5,0) |- (subglobalmodel.east) -->

<!-- node[midway,above] {}; -->

<!-- \draw[arrowdata] (globalsubdata.east) -- (subglobalmodel.west); -->

<!-- \draw[arrowdata] (globalsubdata.south) -- (localmodel.west) -->

<!-- node[midway,above] {}; -->

<!-- % --- Parameter arrow --- -->

<!-- \draw[arrowparam] (globalmodel.south) -- (subglobalmodel.north); -->

<!-- \draw[arrowparam] (subglobalmodel.south) -- (localmodel.north); -->

<!-- % --- Legend --- -->

<!-- % \node[arrowparam, below=1.2cm of localmodel.west, anchor=west] (leg1) {};  -->

<!-- % \node[right=0.3cm of leg1] {\textcolor{param}{$\rightarrow$ Parameter estimates}}; -->

<!-- \node[below=1.2cm of localmodel.west](parameter) {\textcolor{param}{$\rightarrow$ Parameter estimates}}; -->

<!-- \node[right=1cm of parameter] {\textcolor{data}{$\rightarrow$ Data}}; -->

<!-- \end{tikzpicture} -->

<!-- \end{adjustbox} -->

<!-- \caption{Workflow for nationally-informed global and local subnational modeling. }\label{fig-nise} -->

<!-- \end{figure} -->

<!-- \clearpage -->

<!-- ``` -->

![Workflow for nationally-informed global and local subnational modeling.](fig/nise.jpg){#fig-nise width="576"}

## Detailed example of subnational estimation using simulated data

### Simulation setup

The simulation setup for subnational parameters and data is summarized in Figure \ref{fig-simusetup} in three panels. As explained above for national estimation, the top panel indicates the hierarchical model considered. For subnational estimation, an additional level is added, with $\mu_r^{(\subnat)} = \mu_{c[r]}^{(\country)} + \eta_{r}^{(\subnat)}$, $\eta_{r}^{(\subnat)}|\sigma_{ \subnat} \sim N(0, \sigma_{ \subnat})$.

As previously explained, we chose simple normal densities as data generating mechanisms in the simulation, to focus the modeling on the hierarchical model and the `localhierarchy` functionality as opposed to the data model aspects of modeling. Subnational data follows a normal distribution with constant variance: $$y^{(subnat)}_i|\mu^{(subnat)}_{r[i]}, \sigma_y^2 \sim N(\mu^{(subnat)}_{r[i]}, \sigma_y^2),$$ where $r[i]$ refers to the subnational region of subnational observation $i$. In this simulation setup, for simplicity, we generate subnational data independently of national-level data, and we use the same constant data variance at the national and subnational levels. In real examples, data variances are likely to differ (for example, because subnational sampling errors are larger at the subnational level) and national and subnational data may be derived from the same source. We discuss an example of those settings in the case study.

Simulated data at the subnational level was generated using the `simulate_multilevel_data` function described above. For subnational levels, we set $\sigma_{\subnat} = 0.2$, and we created 20 subnational regions in each country and 10 observations per region. In the simulated data, `level1` refers to the country level and `level2` refers to the subnational level. The data sets contain the simulated parameters (`eta`) and data (`y`):

```{r}
dat_subnat <- dat_all$data
dat_subnat |> dplyr::select(level1, level2, mu_global, level1_eta, level2_eta, y)
```

### Modeling

A NISE model is fitted as follows:

```{r}
area_subnat <- "level2"
global_fitsubnat_seq <- fit_model_localhierarchy(
   runstep = "global_subnational",
   area = area_subnat, # subnational area name 
   survey_df = dat_subnat, # pass on subnat data
   # for NISE:
   global_fit = global_fit, # global national fit
   # what level to add to the hierarchy, compared to the 
   # global national model 
   add_subnational_hierarchy = area_subnat
  )
```

Through the `add_subnational_hierarchy` argument, and as shown in the printed statements, the hierarchical structure is now given by intercept $\rightarrow$ country $\rightarrow$ subnational level. By default, the world mean and across-country variance are fixed. Code excerpts to do so are as follows:

```{r, eval = FALSE}
hierarchical_level <- global_fit$hierarchical_level
hierarchical_level <- c(hierarchical_level, add_subnational_hierarchy)
hierarchical_level_terms_fixed <-
  hierarchical_level[1:(length(hierarchical_level)-2)]
hierarchical_level_sigmas_fixed <-
  hierarchical_level[1:(length(hierarchical_level)-1)]
```

By comparing the fit summaries from the global national and global subnational fits for the $\sigma$s, we see that, as expected, one additional $\sigma_{\mu}$ is estimated in the subnational model (to capture variability across subnational regions) and the $\sigma_{\mu}$ at the higher country level is the same in the global national and subnational fit:

```{r}
global_fit$post_summ |>
  dplyr::filter(stringr::str_detect(variable_no_index, "sigma"))
global_fitsubnat_seq$post_summ |>
  dplyr::filter(stringr::str_detect(variable_no_index, "sigma"))
```

We can use the subnational global fit to do a local subnational fit, using the `runstep = "local_subnational"` setting:

```{r}
fit_local_seq <- fit_model_localhierarchy(
  runstep = "local_subnational",
  area = area_subnat,
  survey_df = dat_subnat,
  global_fit = global_fitsubnat_seq
)
```

Similarly to the local national run, in subnational local runs, hierarchical levels and which parameters are fixed is set in the wrapper function; we estimate subnational parameters only. Point estimates in the subnational global fit include point estimates from the national global run as well as point estimates from the global subnational fit. By default, parameters that are duplicated between the two fits, e.g., world region or country means, are taken from the national global run. This is implemented as such to avoid the situation where local runs would fail for countries that were not included in the subnational global fitting, i.e., when country parameters were fixed and missing from the subnational fit. Alternatively, if the user wants to use parameter estimates from the subnational global fit in these settings, the argument `use_globalsubnat_fromnat` can be used when calling the `fit_model_localhierarchy` function, see documentation. <!-- If the fixed parameters differ between national and subnational global fits, i.e., if country means are re-estimated in the global subnational fit as in this example, and if the user wants to use these fixed parameter estimates from the subnational global fit, i.e., if the user wants to use the fixed country estimates from the global national run, the argument `use_globalsubnat_fromnat` can be used when calling the `fit_model_localhierarchy` function, see documentation. -->

We can create and check summaries of subnational fits using the same functions for national fits. Below we compare the subnational global fit with the local subnational fit. The results are comparable, as expected.

```{r, message=FALSE, warning=FALSE}
res_globalsubnat_seq <- posterior_summary_hierparam_localhierarchy(
  fit = global_fitsubnat_seq,
  parname = "mu"
)

res_local_seq <- posterior_summary_hierparam_localhierarchy(
  fit = fit_local_seq, 
  parname = "mu"
)
```

```{r}
plots <- plot_posterior_summaries_localhierarchy(
  res = res_local_seq, 
  modelname1 = "local",
  res2 = res_globalsubnat_seq, modelname2 = "global",
  hierarchy_select = "level2",
  areas_select = unique(res_local_seq$level2$name)[1:30]
)

plots$level2
```

<!-- could add back the direct subnat fit here too: two local subnational fits: one created from the sequential approach introduced above, and one create from a subnational global fit that did not use national level information. The results are comparable, as expected.  -->

## Application: Subnational estimation of family planning indicators using FPET

Subnational estimation of family planning indicators is of interest to country M&E officers for informing family planning programming. To that end, the Track20 project compiled survey data at the subnational level over 35 low- and middle income countries.

For subnational estimation, the workflow used mirrors the NISE approach described in this paper: global modeling of national-level indicators is carried out first, followed by subnational model fitting using a global data base, and finally by local fits. This sequential approach, in which the global subnational model is based on global national modeling, was motivated by differences in data availability between national and subnational global databases: When estimating family planning indicators for married women of reproductive age, the global national database contains observations from 198 countries, whereas the global subnational database includes observations from 35 countries only.

@fig-subnatfits show illustrations of regional fits for Benin. The subnational model is fitted to all regional data from the country. @fig-subnatoverview illustrates fits in selected regions and differences across regions in 2024.

![Data, estimates, and forecasts from 1970 until 2030 for FP indicators for married women in subnational regions in Benin. Graphs show modern contraceptive use, unmet need for modern methods, demand, and demand satisfied with modern methods. Survey data are shown in colored dots with 95% confidence intervals that reflect total error variance. FPET estimates are shown in black, with grey shaded areas representing 90% credible intervals.](fig/fpet_subnat.jpg){#fig-subnatfits}

![Regional estimates for Benin for modern contraceptive use in 2024. Point estimates and 95% credible intervals shown.](fig/subnat_overview.jpg){#fig-subnatoverview}

<!-- The figures below show illustrations of regional fits for Cote d'Ivoire. The subnational model is fitted to all data from the country, here the combination of regional data based on the most recent DHS survey, and national data for other survey-years (not shown in regional plots). This results in estimates for recent years based on all available information. An example, estimates of modern contraceptive use in 2024, is shown as well. -->

{{< pagebreak >}}

# Conclusions

Bayesian hierarchical models are widely used in global health estimation, where data availability may vary across national or subnational populations. For analysis at a local level, local models are often of interest, referring to models that are derived from global hierarchical models but adapted such that they can be fitted to the data from one population alone. To that end, we introduced the `localHierarchy` R package, which provides functionality for fitting Bayesian hierarchical models in settings where both global and local estimation is required.

We have used the `localHierarchy` functionality in different projects. We discussed the estimation of family planning indicators, where country M&E officers use the local model to produce estimates at the national and subnational level. In this area, M&E officers have successfully used local models to produce national estimates since 2014. Availability of a local modeling tool has enabled users to do additional analyses and check sensitivity of estimates to specific data sources or data quality assumptions. In addition to fitting the model to survey data, users of the local family planning model can also incorporate additional data from routine information systems (e.g., the number of contraceptive commodities supplied at family planning facilities, see [@mooney_emu]). These use cases illustrate the value of local models to enable local analysis.

More recently, we have used the `localHierarchy` approach and functionality for estimating coverage indicators for the *Countdown to 2030 for Women’s, Children’s and Adolescents’ Health initiative.* This initiative focuses on “tracking progress of life-saving interventions for Reproductive, Maternal, Newborn, Child and Adolescent Health and Nutrition” in low- and middle-income countries, see [www. countdown2030.org](https://www.%20countdown2030.org/). By developing the `localHierarchy` package and providing use cases in this paper, we hope that this work can be useful for other global health modelers, to consider local modeling in their own work.

### Data availability statement {.unnumbered}

No data are associated with the software tool described in this article.

### Software availability {.unnumbered}

The R package is available at [github.com/AlkemaLab/localhierarchy](https://github.com/AlkemaLab/localhierarchy) and Zenodo \[to do: add reference\]. The code is licensed XXX.

### Grant information {.unnumbered}

This work was supported, in whole or in part, by the Gates Foundation (INV-00844 and OPP1192802). Under the grant conditions of the Foundation, a Creative Commons Attribution 4.0 Generic License has already been assigned to the Author Accepted Manuscript version that might arise from this submission.

# Appendix

## Appendix I: Excerpts from the Stan model

The same Stan model is used for both global and local models. Excerpts are given in this section to explain key parts.

The first excerpt starts at the end in terms of model specification and concerns the specification of the hierarchical parameters $\mu_c$, using the `localhierarchy` Stan function `get_mu`:

```{r, eval = FALSE}
data {
  matrix[n_geounit, mu_raw_n_terms] mu_model_matrix;
}

transformed data {
  vector[rows(csr_extract_w(mu_model_matrix))] mu_model_matrix_w     
              = csr_extract_w(mu_model_matrix);
  array[size(csr_extract_v(mu_model_matrix))] int mu_model_matrix_v  
              = csr_extract_v(mu_model_matrix);
  array[size(csr_extract_u(mu_model_matrix))] int mu_model_matrix_u  
              = csr_extract_u(mu_model_matrix);
}

transformed parameters {
 vector[n_geounit] mu = get_mu(
    mu_star,
    mu_raw_n_terms,
    n_geounit,
    mu_model_matrix_w, mu_model_matrix_v, mu_model_matrix_u);
}
```

Here we use that $(\mu_1^{(country)}, ..., \mu_C^{(country)}) = M \cdot (\eta_1, ..., \eta_C)$, where matrix $M$ is a sparse matrix with 1s and 0s, and $(\eta_1, ..., \eta_c)$ refers to the vector with products of standard deviation and $\gamma$ terms. The function `get_mu` calculates the vector of $\mu_c^{(country)}$s from the vector of $\eta$s (`mu_star` in the Stan model) and a decomposition of $M$ into different parts $U$, $V$, $W$. This implementation uses the sparse representation of the model matrix $M$ with Stan functions `csr_matrix_times_vector` and `crs_extract`.

The second Stan model excerpt concerns the specification of the $\eta$s (`mu_star`). This vector is obtained by multiplying the vector of $\gamma$s, which is referred to as `mu_raw` in the Stan model by their respective standard deviation, i.e., the vector containing $s_{\glob}$ (labeled `mu_scalarprior_mean` in the Stan model) and the vector of stacked $\sigma$s (labeled `mu_sigma` in the Stan model). To allow for global and local models, additions `_estimate` and `_fixed` are used to allow for splitting the `mu_raw` vector into two parts, one for fixed and one for estimated parameters. Similarly, vector `mu_sigma` is also split into two parts, one part for fixed and one part for estimated parameters. Relevant Stan code is as follows:

```{r, eval = FALSE}
data {
  // terms of hierarchical model
  int<lower=0> mu_raw_n_terms;
  int<lower=0> mu_raw_n_terms_fixed;
  int<lower=0> mu_raw_n_terms_estimate;
  int<lower=0> mu_n_sigma;
  int<lower=0> mu_n_sigma_fixed;
  int<lower=0> mu_n_sigma_estimate;
  array[mu_n_sigma + 1] int<lower=1, upper=mu_raw_n_terms> mu_re_start;
  array[mu_n_sigma + 1] int<lower=1, upper=mu_raw_n_terms> mu_re_end;
  // values of fixed parameters
  vector[mu_raw_n_terms_fixed] mu_raw_fixed;
  vector<lower=verysmallnumber>[mu_n_sigma_fixed] mu_sigma_fixed;
  // prior parameters
  real<lower = verysmallnumber> mu_scalarprior_sd;
  real mu_scalarprior_mean;
  real<lower = verysmallnumber> mu_prior_sd_sigma_estimate;
}

parameters {
  vector[mu_raw_n_terms_estimate] mu_raw_estimate;
  vector<lower=verysmallnumber>[mu_n_sigma_estimate] mu_sigma_estimate;
}

transformed parameters {
 vector[mu_raw_n_terms] mu_star = get_mu_star(
    mu_n_sigma, mu_n_sigma_fixed, mu_n_sigma_estimate,
    mu_sigma_fixed, mu_sigma_estimate,
    mu_scalarprior_mean,
    mu_scalarprior_sd,
    mu_raw_n_terms, mu_raw_n_terms_fixed, mu_raw_n_terms_estimate,
    mu_raw_fixed, mu_raw_estimate,
    mu_re_start, mu_re_end);
}
model {
  to_vector(mu_raw_estimate) ~ std_normal();
  to_vector(mu_sigma_estimate) ~ normal(0, mu_prior_sd_sigma_estimate);
}
```

In the model code, the data block contains the input data for the $\gamma$s and $\sigma$s. The `localhierarchy` Stan function `get_mu_star` is used to obtain the $\eta$s. Its arguments also include prior parameters `mu_scalarprior_mean` and `mu_scalarprior_sd`, which refer to the (rescaled) prior mean and standard deviation of $\mu^{(\glob)}$. The model block contains the priors for the $\gamma$s and $\sigma_{k}$s, given by \begin{align*}
  \mu^{(\glob)} &\sim N(0,1),\\
  \sigma_{k} &\sim \text{Half-Normal}(0, s_{\sigma}).
\end{align*} All prior parameters are added as input data to the Stan model.

<!-- In fit_model function, prior parameters are set for the specific parname: stan_data\[\[paste0(parname, "\_scalarprior_sd")\]\] \<- etc. The prior sd parameters are used in plotting. For the prior on the intercept, the following transformation is used: mu_global = prior sd\*(gamma + mu_prior_mean), such that gamma = mu_global/sd - mu_prior_mean. (not doing the /sd would be easier for specification going forward?) -->

## Appendix II: Documentation of the `fit_model_localhierarchy` function {#sec-helpfilefitmodel}

| **Argument** | **Description** |
|------------------------------------|------------------------------------|
| **`survey_df`** | Tibble with survey data |
| **`y`** | Column name of outcome, defaults to **`y`**. |
| **`area`** | Column name of the area of each observation (used as geounit; iso or subnational region) |
| **`area_select`** | Area name to use for local run (e.g., iso code or subnational region name) |
| **`runstep`** | Type of run, defines which model fitting step to perform (see Details for options). |
| **`global_fit`** | Optional global fit object, used to obtain fixed values for some parameters in the current fit (see Details). |
| **`hierarchical_level`** | Vector specifying hierarchical structure used for mu. Should list elements in hierarchical order from `intercept` downward (see Details for examples). |
| **`add_subnational_hierarchy`** | Level that's added to the hierarchy for subnational analysis, defaults to `subnat`. |
| **`use_globalsubnat_fromnat`** | Logical; for local subnational runs, whether to use the global fit derived from national data (requires **`fit_globalsubnat_fromnat`** in **`global_fit`** if TRUE). |
| **`mu_isvector`** | Logical, TRUE if mu is a vector, defaults to FALSE |
| **`chains`** | Number of chains to run (sampling parameter) |
| **`iter_sampling`** | Number of posterior samples to draw (sampling parameter) |
| **`iter_warmup`** | Number of warmup iterations (sampling parameter) |
| **`compile_model`** | Boolean indicator of whether to compile the Stan model |
| **`force_recompile`** | Boolean indicator of whether to force recompilation of the Stan model |
| **`seed`** | Random seed |
| **`refresh`** | Number of iterations between progress updates |
| **`adapt_delta`** | Target acceptance rate for the No-U-Turn Sampler |
| **`max_treedepth`** | Maximum tree depth for the No-U-Turn Sampler |

### Details

The `fit_model_localhierarchy` function fits the toy example for hierarchical models/seq fitting. The argument `runstep` determines the type of run to perform. The following run steps are supported:

-   "global_national": Fit the global model.

-   "local_national": Fit the model to data from a single country, using a global_national fit.

-   "global_subnational": Fit the model to global database with subnational data, using a global_national fit.

-   "local_subnational": Fit the model to subnational data from a single country or region, using a global_subnational fit. This is also explained in the documentation folder.

Details on hierarchical set ups used The package allows the structure of the hierarchical prior to be configured by the user through the `hierarchical_level` argument. These arguments expect a character vector that specifies a nesting hierarchical structure. Each element of the vector must be either "intercept" or a column name in the survey dataset, where "intercept" will add a global intercept for the parameter. The vector must be in descending order in terms of the hierarchy: that is, it starts with "intercept" and proceeds down the hierarchy.

For example, suppose we are fitting country-level data, where the dataset has columns "name_country", "name_sub_region", and "name_region" containing the name of the country, sub-region, and region that each observation belongs to. To specify that parameter mu should be fitted with a hierarchical model in which countries are nested within sub-regions within regions within world, we would use the argument `hierarchical_level = c("intercept", "name_region", "name_sub_region", "name_country")`.

Optionally, model parameters can be fixed to values from a previous model fit provided via the `global_fit` argument. In a typical use case, the `global_fit` will have been fit to data from many geographic units (e.g., all countries), while the current fit uses data from a smaller number of locations. When using a global_fit to fix parameter values, what exactly is fixed is determined by the runstep and global_fit combi. see options in function

### Value

List that contains samples, stan_data, other information relevant to model fit (arguments), and for global fits, point estimates of relevant parameters (post_summ). For subnational global fits, the list includes fit_globalsubnat_fromnat, which is the global fit with additional subnational sigmas added to the postsum object.

# References
