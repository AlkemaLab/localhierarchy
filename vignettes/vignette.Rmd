---
title: "[Vignette] Global and local model fitting using the R package localhierarchy"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{[Vignette] Global and local model fitting using the R package localhierarchy}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```




This vignette demonstrates how to do global and local model fitting based on simulated data, to illustrate the functionality to do estimation at a national and subnational level. 
Detailed explanations of the model set up and code are given in the main article. 



```{r setup}
library(localhierarchy)
```

# Simulation setup
Simulated data were generated using the `simulate_multilevel_data` function. We simulate a set of model parameters, setting $\mu^{(\mathrm{global})} = 0$, and $\sigma_{\mathrm{country}} = 0.5$, creating 30 countries, and national data, using $\sigma_y = 0.1$. The function call is as follows (note that the function also generates parameters and data at the subnational level, these are used in the second section):

```{r}
dat_all <- simulate_multilevel_data(
  n_levels = 2,
  n_units_perlevel = c(30, 20),
  sigma_perlevel = c(0.5, 0.2), # national and subnational level
  mu_global = 0,
  add_data = TRUE,
  n_data = 10,
  sigma_y = 0.1, # used for national and subnational data
  add_data1levelup = TRUE
)
dat_nat <- dat_all$data_1levelup
```

In the simulated data, `level1` refers to the country level. The data sets contain the simulated parameters (`eta`; the deviation away from the global mean) and data (`y`):

```{r}
dat_nat |> dplyr::select(level1,  mu_global, level1_eta, y)
```

# National model fitting

For model fitting, the first step is to specify a hierarchical structure, using `intercept` and names included in the survey data. For national level estimation, `level1` is the name used in the data:

```{r}
hierarchical_level <- c("intercept",  "level1")
```

We can use the function `fit_model_localhierarchy` for model fitting. The argument `runstep` is used to define the type of model, setting it to `"global_national"` results in fitting a model to all data without fixing any parameters. Other arguments include the hierarchical level specification, the area, and survey data. When calling the function, print statements are used to inform the user of key points related to the model fit:

```{r}
global_fit <- fit_model_localhierarchy(
  runstep = "global_national",
  hierarchical_level = hierarchical_level,
  area = "level1",
  survey_df = dat_nat
)
```


The `global_fit` object includes posterior samples and other metadata about the fit.

```{r}
names(global_fit)
```

The `post_summ` object contains posterior means for relevant model parameters. For example:

```{r}
global_fit$post_summ |> 
  dplyr::filter(variable_no_index == "mu_sigma")
```

A local fit can be estimated by passing on the global fit object to the wrapper function and including data for countries of interest. Here we do local runs for all countries, by including the entire data set, and specify what to fix using the `runstep` argument:

```{r}
fit_local <- fit_model_localhierarchy(
  runstep = "local_national",
  global_fit = global_fit,
  area = "level1",
  survey_df = dat_nat
)
```

When doing a local national run with `runstep = "local_national"`, the hierarchical levels are taken from the global fit, and non-country-specific parameters are fixed. This is indicated in the print statements above. 



## Processing model fits

The package includes several functions to produce and check outputs. The function `posterior_summary_hierparam` is used to summarize posterior draws for hierarchical parameters, to produce summaries of $\mu$ at any level of interest. It takes a fitted model object and a parameter name as input and returns a list with each entry referring one level, and the results (e.g., estimates for $\mu$ estimates) for that level. Here we obtain these results for the global and local model:

```{r, message=FALSE, warning=FALSE}
res_global <- posterior_summary_hierparam_localhierarchy(
  fit = global_fit, parname = "mu")
res_local <- posterior_summary_hierparam_localhierarchy(
  fit = fit_local, parname = "mu")
```

Example output for the global model is as follows:

```{r}
res_local$level1
```

The column `name` includes the country names, given by simple indices in this simulation. The column `quant` above refers to posterior means and upper and lower bounds of 95% credible intervals. We can create plots to show outputs, for example for the first 4 countries:

```{r}
plots <- plot_posterior_summaries_localhierarchy(
  res = res_global, 
  modelname1 = "global",
  hierarchy_select = "level1",
  areas_select = unique(res_local$level1$name)[1:4]
)

plots$level1
```

By plotting results from global and local models, we can check how estimates compare and how values have been fixed in the local runs. For example, here we see how country estimates compare between global and local models:

```{r}
plots <- plot_posterior_summaries_localhierarchy(
  res = res_local, 
  modelname1 = "local",
  res2 = res_global, 
  modelname2 = "global", 
  hierarchy_select = "level1",
  areas_select = unique(res_local$level1$name)[1:4]
)

plots$level1
```

Estimates are similar, as expected.

When visualizing higher levels, we see how parameters were fixed in the local model:

```{r}
plots <- plot_posterior_summaries_localhierarchy(
  res = res_local, 
  modelname1 = "local",
  res2 = res_global, 
  modelname2 = "global"
)

plots$intercept 
```

We can also create plots for the $\gamma$s (`mu_raw`s):

```{r, message=FALSE, warning=FALSE}
plots <- plot_muraw_localhierarchy(fit = global_fit, parname = "mu")
```

This gives a list with plots, including summary plots and plots with priors and posteriors. For example, the figures below show the first 30 $\gamma$s, followed by the prior-posterior densities for the first $\gamma$ (referring to the intercept).

```{r}
plots[["summary_plots"]][[1]]
```

```{r}
plots[["plots_allmuraw"]][[1]]
```

Plots with prior and posterior densities of the $\sigma$s can be produced as well:

```{r}
plot_prior_post_sigmas_localhierarchy(fit = global_fit, parname = "mu")
```




# Subnational model fitting

The simulated data at the subnational level is given by:
```{r}
dat_subnat <- dat_all$data
dat_subnat |> dplyr::select(level1, level2, mu_global, level1_eta, level2_eta, y)
```

A *nationally-informed subnational estimation* (NISE) model is fitted as follows:

```{r}
area_subnat <- "level2"
global_fitsubnat_seq <- fit_model_localhierarchy(
   runstep = "global_subnational",
   area = area_subnat, # subnational area name 
   survey_df = dat_subnat, # pass on subnat data
   # for NISE:
   global_fit = global_fit, # global national fit
   # what level to add to the hierarchy, compared to the 
   # global national model 
   add_subnational_hierarchy = area_subnat
  )
```

Through the `add_subnational_hierarchy` argument, and as shown in the printed statements, the hierarchical structure is now given by intercept $\rightarrow$ country $\rightarrow$ subnational level. By default, the world mean and across-country variance are fixed. 

By comparing the fit summaries from the global national and global subnational fits for the $\sigma$s, we see that, as expected, one additional $\sigma_{\mu}$ is estimated in the subnational model (to capture variability across subnational regions) and the $\sigma_{\mu}$ at the higher country level is the same in the global national and subnational fit:

```{r}
global_fit$post_summ |>
  dplyr::filter(stringr::str_detect(variable_no_index, "sigma"))
global_fitsubnat_seq$post_summ |>
  dplyr::filter(stringr::str_detect(variable_no_index, "sigma"))
```

We can use the subnational global fit to do a local subnational fit, using the `runstep = "local_subnational"` setting:

```{r}
fit_local_seq <- fit_model_localhierarchy(
  runstep = "local_subnational",
  area = area_subnat,
  survey_df = dat_subnat,
  global_fit = global_fitsubnat_seq
)
```

Similarly to the local national run, in subnational local runs, hierarchical levels and which parameters are fixed is set in the wrapper function; we estimate subnational parameters only. Point estimates in the subnational global fit include point estimates from the national global run as well as point estimates from the global subnational fit. By default, parameters that are duplicated between the two fits, e.g., world region or country means, are taken from the national global run. This is implemented as such to avoid the situation where local runs would fail for countries that were not included in the subnational global fitting, i.e., when country parameters were fixed and missing from the subnational fit. Alternatively, if the user wants to use parameter estimates from the subnational global fit in these settings, the argument `use_globalsubnat_fromnat` can be used when calling the `fit_model_localhierarchy` function (see documentation). 

We can create and check summaries of subnational fits using the same functions for national fits. Below we compare the subnational global fit with the local subnational fit. The results are comparable, as expected.

```{r, message=FALSE, warning=FALSE}
res_globalsubnat_seq <- posterior_summary_hierparam_localhierarchy(
  fit = global_fitsubnat_seq,
  parname = "mu"
)

res_local_seq <- posterior_summary_hierparam_localhierarchy(
  fit = fit_local_seq, 
  parname = "mu"
)
```

```{r}
plots <- plot_posterior_summaries_localhierarchy(
  res = res_local_seq, 
  modelname1 = "local",
  res2 = res_globalsubnat_seq, modelname2 = "global",
  hierarchy_select = "level2",
  areas_select = unique(res_local_seq$level2$name)[1:30]
)

plots$level2
```
